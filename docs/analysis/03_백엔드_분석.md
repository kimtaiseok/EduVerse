# 03. 백엔드 분석

## Flask 애플리케이션 구조

### 애플리케이션 초기화
**파일**: [main.py:1-16](../../main.py:1-16)

```python
from flask import Flask, render_template, jsonify, request
import firebase_admin
from firebase_admin import credentials, firestore
from werkzeug.security import generate_password_hash, check_password_hash

# Firebase 초기화 (중복 방지)
if not firebase_admin._apps:
    firebase_admin.initialize_app(options={
        'projectId': 'my-python-65210-65c44',
    })

db = firestore.client()
app = Flask(__name__, static_folder='static', template_folder='templates')
```

**특징**:
- 싱글톤 패턴으로 Firebase 앱 초기화 (`_apps` 체크)
- Firestore 클라이언트 전역 변수 `db`
- 정적 파일 경로 명시적 설정

---

## API 엔드포인트 분석

### 엔드포인트 개요
총 **26개 API 엔드포인트** + **4개 렌더링 라우트**

| 카테고리 | 엔드포인트 수 | 주요 기능 |
|----------|--------------|----------|
| 렌더링 라우트 | 4 | HTML 템플릿 제공 |
| 인증 | 2 | 회원가입, 로그인 |
| 시나리오 | 1 | 주차별 커리큘럼 조회 |
| 진행 상황 | 5 | 진행도 저장, 일시정지, 라이브 코드 |
| 클래스 관리 | 5 | 생성, 삭제, 참여, 조회 |
| Q&A | 3 | 질문 등록, 답변, 조회 |
| 로깅 | 2 | 제출 로그, 회고 로그 |
| 분석 | 2 | 클래스 분석, 개인 성장 분석 |
| 기타 | 1 | 강의 인트로 확인 |

---

## 1. 렌더링 라우트

### 1.1 메인 페이지
**Route**: `GET /` ([main.py:18-20](../../main.py:18-20))

```python
@app.route('/')
def home():
    return render_template('index.html')
```

**응답**: [index.html](../../templates/index.html:1) (592 라인)
**역할**: 학습자/교수자 통합 메인 인터페이스

### 1.2 모니터링 페이지
**Route**: `GET /monitor` ([main.py:22-24](../../main.py:22-24))

```python
@app.route('/monitor')
def monitor():
    return render_template('monitor.html')
```

**응답**: [monitor.html](../../templates/monitor.html:1) (100 라인)
**역할**: 교수자 실시간 모니터링 대시보드

### 1.3 분석 리포트
**Route**: `GET /report` ([main.py:26-28](../../main.py:26-28))

**응답**: [report.html](../../templates/report.html:1) (132 라인)
**역할**: 클래스 성과 분석 및 리포트

### 1.4 성장 트래킹
**Route**: `GET /growth` ([main.py:30-32](../../main.py:30-32))

**응답**: [growth.html](../../templates/growth.html:1) (50 라인)
**역할**: 개인 학습 성장 시각화

---

## 2. 인증 API

### 2.1 회원가입
**Route**: `POST /api/signup` ([main.py:46-71](../../main.py:46-71))

**요청 바디**:
```json
{
  "name": "홍길동",
  "email": "hong@example.com",
  "password": "password123",
  "role": "student"  // 또는 "instructor"
}
```

**처리 로직**:
1. 이메일 중복 확인
2. 비밀번호 해싱 (`pbkdf2:sha256`)
3. Firestore `users` 컬렉션에 문서 생성
4. 초기 진행도 설정 (`week: 1, cycle: 0`)

**응답 (성공)**:
```json
{
  "status": "success",
  "message": "회원가입이 완료되었습니다."
}
```

**응답 (실패 - 이메일 중복)**:
```json
{
  "status": "error",
  "message": "이미 가입된 이메일입니다."
}
```

**Firestore 문서 구조**:
```javascript
users/{email} = {
  name: "홍길동",
  email: "hong@example.com",
  passwordHash: "$pbkdf2-sha256$...",
  role: "student",
  progress: { week: 1, cycle: 0 },
  lastSeenIntroWeek: 0,
  seenCodingIntros: []
}
```

### 2.2 로그인
**Route**: `POST /api/login` ([main.py:73-121](../../main.py:73-121))

**요청 바디**:
```json
{
  "email": "hong@example.com",
  "password": "password123"
}
```

**처리 로직**:
1. 이메일로 사용자 조회
2. 비밀번호 검증:
   - **최신**: `check_password_hash()` 사용
   - **레거시**: 평문 비밀번호 비교 (마이그레이션 지원)
3. 주차 인트로 표시 여부 결정
4. 사용자 데이터 반환

**주차 인트로 로직** ([main.py:87-96](../../main.py:87-96)):
```python
current_week = user_data.get('progress', {}).get('week', 1)
last_seen_week = user_data.get('lastSeenIntroWeek', 0)

if current_week > last_seen_week:
    show_intro = True
    user_ref.update({'lastSeenIntroWeek': current_week})
```

**응답 (성공)**:
```json
{
  "status": "success",
  "message": "로그인 성공!",
  "user": {
    "name": "홍길동",
    "email": "hong@example.com",
    "role": "student",
    "progress": { "week": 3, "cycle": 5 },
    "showWeeklyIntro": true,
    "seenCodingIntros": ["week1_cycle0", "week2_cycle1"],
    "classId": "abc123xyz",
    "password": "password123"  // ⚠️ 클라이언트 재인증용
  }
}
```

**보안 고려사항**:
- ✅ 비밀번호 해싱 (Werkzeug)
- ⚠️ 비밀번호가 응답에 포함됨 (세션 재인증 목적)
- ⚠️ JWT 대신 평문 비밀번호 사용 (개선 필요)

---

## 3. 시나리오 API

### 3.1 주차별 시나리오 조회
**Route**: `GET /api/scenario/week/<int:week_num>` ([main.py:34-44](../../main.py:34-44))

**예시 요청**:
```
GET /api/scenario/week/3
```

**처리 로직**:
1. `scenarios` 컬렉션에서 `week_{week_num}` 문서 조회
2. 문서가 없으면 404 반환

**응답 (성공)**:
```json
{
  "week": 3,
  "title": "흐름 제어: 조건과 반복",
  "cycles": [
    {
      "title": "if 조건문",
      "syntax_key": "if_statement",
      "filename": "check_age.py",
      "starterCode": "# 나이 확인 코드...",
      "testCode": "assert age >= 19, '성인만 가능'",
      "task": { ... },
      "briefing": { ... },
      "lecture": { ... },
      "feedback": { ... }
    },
    ...
  ]
}
```

**데이터 소스**: [scenario.json](../../scenario.json:1) (2,253 라인)

---

## 4. 진행 상황 API

### 4.1 진행도 업데이트
**Route**: `POST /api/progress/update` ([main.py:124-135](../../main.py:124-135))

**요청 바디**:
```json
{
  "email": "hong@example.com",
  "progress": {
    "week": 4,
    "cycle": 2
  }
}
```

**처리 로직**:
```python
db.collection('users').document(email).update({'progress': progress})
```

### 4.2 라이브 코드 업데이트
**Route**: `POST /api/livecode/update` ([main.py:137-153](../../main.py:137-153))

**요청 바디**:
```json
{
  "email": "hong@example.com",
  "liveCode": "print('Hello World')"
}
```

**처리 로직**:
```python
db.collection('users').document(email).set({
    'liveCode': live_code,
    'lastActive': firestore.SERVER_TIMESTAMP
}, merge=True)
```

**용도**: 교수자가 학습자 코드를 실시간으로 모니터링

### 4.3 일시정지 상태 저장
**Route**: `POST /api/pause/set` ([main.py:155-167](../../main.py:155-167))

**요청 바디**:
```json
{
  "email": "hong@example.com",
  "pauseState": {
    "view": "lecture",
    "code": "x = 10\nprint(x)"
  }
}
```

**용도**: 학습자가 중간에 로그아웃해도 진행 상태 복원

### 4.4 일시정지 상태 해제
**Route**: `POST /api/pause/clear` ([main.py:169-180](../../main.py:169-180))

**처리 로직**:
```python
db.collection('users').document(email).update({
    'pauseState': firestore.DELETE_FIELD
})
```

### 4.5 강의 인트로 확인 기록
**Route**: `POST /api/coding-intro/seen` ([main.py:561-579](../../main.py:561-579))

**요청 바디**:
```json
{
  "email": "hong@example.com",
  "introKey": "week3_cycle2"
}
```

**처리 로직**:
```python
user_ref.update({
    'seenCodingIntros': firestore.ArrayUnion([intro_key])
})
```

**용도**: 같은 인트로를 반복해서 보지 않도록 추적

---

## 5. 클래스 관리 API

### 5.1 클래스 생성
**Route**: `POST /api/classes/create` ([main.py:197-234](../../main.py:197-234))

**요청 바디**:
```json
{
  "instructorEmail": "prof@example.com",
  "classDetails": {
    "subject": "Python 프로그래밍",
    "year": "2025",
    "semester": "1학기",
    "department": "컴퓨터공학과",
    "section": "01"
  }
}
```

**처리 로직**:
1. 6자리 초대 코드 생성 (대문자+숫자)
2. Firestore에 새 클래스 문서 생성
3. 초대 코드 반환

**초대 코드 생성** ([main.py:182-183](../../main.py:182-183)):
```python
def generate_invite_code(length=6):
    return ''.join(random.choices(string.ascii_uppercase + string.digits, k=length))
```

**응답**:
```json
{
  "status": "success",
  "message": "새로운 수업이 개설되었습니다.",
  "class": {
    "classId": "abc123xyz",
    "className": "[2025 1학기] Python 프로그래밍 (컴퓨터공학과 01분반)",
    "inviteCode": "A3B7X9",
    "students": []
  }
}
```

### 5.2 클래스 삭제
**Route**: `POST /api/classes/delete` ([main.py:236-267](../../main.py:236-267))

**요청 바디**:
```json
{
  "classId": "abc123xyz",
  "instructorEmail": "prof@example.com"
}
```

**처리 로직** (트랜잭션):
1. 클래스 존재 및 권한 확인
2. 모든 학생의 `classId` 필드 삭제
3. 클래스 문서 삭제
4. Batch commit

**Batch 처리** ([main.py:256-263](../../main.py:256-263)):
```python
batch = db.batch()
for email in student_emails:
    student_ref = db.collection('users').document(email)
    batch.update(student_ref, {'classId': firestore.DELETE_FIELD})
batch.delete(class_ref)
batch.commit()
```

### 5.3 클래스 참여
**Route**: `POST /api/classes/join` ([main.py:269-295](../../main.py:269-295))

**요청 바디**:
```json
{
  "inviteCode": "A3B7X9",
  "studentEmail": "hong@example.com"
}
```

**처리 로직**:
1. 초대 코드로 클래스 검색
2. 학생이 이미 다른 클래스에 속해있는지 확인
3. 클래스의 `students` 배열에 추가
4. 학생 문서에 `classId` 저장

**ArrayUnion 사용** ([main.py:290](../../main.py:290)):
```python
db.collection('classes').document(class_id).update({
    'students': firestore.ArrayUnion([student_email])
})
```

### 5.4 클래스 목록 조회
**Route**: `GET /api/classes?email={instructorEmail}` ([main.py:185-195](../../main.py:185-195))

**응답**:
```json
{
  "status": "success",
  "classes": [
    {
      "classId": "abc123",
      "className": "[2025 1학기] Python 프로그래밍...",
      "inviteCode": "A3B7X9",
      "students": ["hong@example.com", "kim@example.com"],
      "createdAt": "2025-10-15T12:34:56Z"
    }
  ]
}
```

### 5.5 클래스 상세 조회
**Route**: `GET /api/class/<class_id>` ([main.py:297-317](../../main.py:297-317))

**응답**:
```json
{
  "status": "success",
  "classInfo": { ... },
  "students": [
    {
      "name": "홍길동",
      "email": "hong@example.com",
      "progress": { "week": 4, "cycle": 2 },
      "liveCode": "print('Hello')",
      "lastActive": "2025-10-22T14:30:00Z"
    }
  ]
}
```

---

## 6. Q&A API

### 6.1 질문 등록
**Route**: `POST /api/question/ask` ([main.py:319-347](../../main.py:319-347))

**요청 바디**:
```json
{
  "email": "hong@example.com",
  "classId": "abc123",
  "question": "for 루프에서 인덱스를 어떻게 가져오나요?",
  "progress": { "week": 3, "cycle": 2 },
  "characterContext": {
    "character": "sena",
    "content": "range() 함수를 사용하여..."
  }
}
```

**Firestore 문서**:
```javascript
questions/{questionId} = {
  questionId: "q123",
  classId: "abc123",
  studentEmail: "hong@example.com",
  question: "...",
  progress: { week: 3, cycle: 2 },
  characterContext: { ... },
  isResolved: false,
  isNotified: false,
  answer: "",
  createdAt: Timestamp
}
```

### 6.2 질문 답변
**Route**: `POST /api/question/answer` ([main.py:349-366](../../main.py:349-366))

**요청 바디**:
```json
{
  "questionId": "q123",
  "answer": "enumerate() 함수를 사용하세요. 예: for i, item in enumerate(list):"
}
```

**처리 로직**:
```python
db.collection('questions').document(question_id).update({
    'answer': answer_text,
    'isResolved': True,
    'isNotified': False
})
```

### 6.3 내 질문 조회
**Route**: `GET /api/questions/my?email={email}` ([main.py:368-383](../../main.py:368-383))

**응답**:
```json
{
  "status": "success",
  "questions": [
    {
      "questionId": "q123",
      "question": "...",
      "answer": "...",
      "isResolved": true,
      "createdAt": "2025-10-22T14:30:00Z"
    }
  ]
}
```

---

## 7. 로깅 API

### 7.1 제출 로그 기록
**Route**: `POST /api/log/submission` ([main.py:385-406](../../main.py:385-406))

**요청 바디**:
```json
{
  "email": "hong@example.com",
  "classId": "abc123",
  "week": 3,
  "cycle": 2,
  "isSuccess": true,
  "error": ""
}
```

**Firestore 문서**:
```javascript
submission_logs/{logId} = {
  logId: "log123",
  studentEmail: "hong@example.com",
  classId: "abc123",
  week: 3,
  cycle: 2,
  isSuccess: true,
  error: "",
  submittedAt: Timestamp
}
```

**용도**: 분석 리포트에서 성공률, 실패 패턴 분석

### 7.2 회고 로그 기록
**Route**: `POST /api/log/reflection` ([main.py:408-428](../../main.py:408-428))

**요청 바디**:
```json
{
  "email": "hong@example.com",
  "classId": "abc123",
  "week": 3,
  "ratings": [
    {
      "topic": "if 조건문",
      "comprehension": 4,
      "application": 3
    }
  ],
  "feedback": {
    "meaningful": "조건문의 논리 구조 이해",
    "difficult": "중첩 조건문",
    "curious": "switch 문은 없나요?"
  }
}
```

**Firestore 문서**:
```javascript
reflections/{reflectionId} = {
  reflectionId: "ref123",
  studentEmail: "hong@example.com",
  classId: "abc123",
  week: 3,
  ratings: [ ... ],
  feedback: { ... },
  submittedAt: Timestamp
}
```

---

## 8. 분석 API

### 8.1 클래스 분석
**Route**: `GET /api/analytics/class/<class_id>` ([main.py:430-530](../../main.py:430-530))

**응답**:
```json
{
  "status": "success",
  "className": "[2025 1학기] Python 프로그래밍...",
  "totalSubmissions": 450,
  "successRate": 78.5,
  "weeklySuccessRate": {
    "1주차": 92.3,
    "2주차": 85.1,
    "3주차": 72.4
  },
  "mostFailedCycles": [
    ["3주차 사이클 5", 12],
    ["4주차 사이클 3", 8]
  ],
  "studentProgress": [
    {
      "name": "홍길동",
      "email": "hong@example.com",
      "week": 5,
      "cycle": 3
    }
  ],
  "reflectionAnalysis": {
    "3": {
      "topics": {
        "if 조건문": {
          "comprehension_avg": 4.2,
          "application_avg": 3.8
        }
      },
      "feedback_summary": {
        "meaningful": ["조건문 이해", "실습 도움"],
        "difficult": ["중첩 조건", "논리 연산자"],
        "curious": ["switch 문?", "삼항 연산자?"]
      },
      "participant_count": 15
    }
  }
}
```

**처리 로직**:
1. 제출 로그 집계 (성공률, 주차별 성공률)
2. 실패 패턴 분석 (`Counter` 사용)
3. 학생 진행도 정렬
4. 회고 데이터 평균 계산

**실패 패턴 분석** ([main.py:457-459](../../main.py:457-459)):
```python
failed_logs = [log for log in logs if not log['isSuccess']]
failure_counter = Counter(f"{log['week']}주차 사이클 {log['cycle'] + 1}" for log in failed_logs)
most_failed_cycles = failure_counter.most_common(5)
```

### 8.2 개인 성장 분석
**Route**: `GET /api/analytics/my-growth?email={email}` ([main.py:532-558](../../main.py:532-558))

**응답**:
```json
{
  "status": "success",
  "data": [
    {
      "week": 3,
      "weekTitle": "흐름 제어: 조건과 반복",
      "cycleTitles": ["if 조건문", "while 루프", "for 루프"],
      "ratings": [ ... ],
      "feedback": { ... },
      "submittedAt": "2025-10-15T18:00:00Z"
    }
  ]
}
```

**처리 로직**:
1. 학생의 모든 회고 조회
2. 각 회고에 주차 제목 및 사이클 제목 매핑
3. 시간순 정렬

---

## 에러 처리 패턴

### 공통 에러 응답 구조
```json
{
  "status": "error",
  "message": "오류 메시지"
}
```

### HTTP 상태 코드
- `200`: 성공
- `201`: 생성 성공
- `400`: 잘못된 요청 (필수 파라미터 누락)
- `401`: 인증 실패
- `403`: 권한 없음
- `404`: 리소스 없음
- `409`: 충돌 (이메일 중복)
- `500`: 서버 오류

### 에러 처리 예시
```python
try:
    # 비즈니스 로직
    ...
except Exception as e:
    return jsonify({
        "status": "error",
        "message": f"서버 오류: {e}"
    }), 500
```

---

## 보안 분석

### 구현된 보안 기능
1. ✅ **비밀번호 해싱**: Werkzeug의 `pbkdf2:sha256`
2. ✅ **이메일 중복 검사**: 회원가입 시
3. ✅ **권한 확인**: 클래스 삭제 시 교수자 확인

### 보안 개선 필요 영역
1. ⚠️ **JWT/세션 토큰**: 현재는 비밀번호를 클라이언트에 저장
2. ⚠️ **CORS 설정**: CORS 헤더 없음 (동일 출처만 허용)
3. ⚠️ **Rate Limiting**: API 호출 횟수 제한 없음
4. ⚠️ **Input Validation**: 입력 검증 최소화 (SQLi는 NoSQL이라 무관)
5. ⚠️ **HTTPS 강제**: 프로덕션에서 필수

---

## 다음 단계
다음 문서에서는 프론트엔드 구조와 UI 컴포넌트를 상세히 분석합니다.

→ [04. 프론트엔드 분석](./04_프론트엔드_분석.md)
